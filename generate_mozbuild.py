#!/usr/bin/env python

import os
import sys
import posixpath

header = """
# Please note this file is autogenerated from generate_mozbuild.py, so do not modify it directly

"""

footers = {
#
# common
#
  'base': """
if CONFIG['GNU_CXX']:
    CXXFLAGS += [
        '-Wno-attributes',
        '-Wno-sign-compare',
        '-Wno-unknown-pragmas',
    ]
    if CONFIG['CLANG_CXX']:
        CXXFLAGS += ['-Wno-unused-private-field']

DEFINES['NOMINMAX'] = True
DEFINES['_CRT_SECURE_NO_DEPRECATE'] = True
DEFINES['_HAS_EXCEPTIONS'] = 0

if not CONFIG['MOZ_DEBUG']:
    DEFINES['_SECURE_SCL'] = 0

DEFINES['ANGLE_ENABLE_D3D9'] = True
DEFINES['ANGLE_ENABLE_D3D11'] = True
DEFINES['ANGLE_COMPILE_OPTIMIZATION_LEVEL'] = 'D3DCOMPILE_OPTIMIZATION_LEVEL1'

# ANGLE uses the STL, so we can't use our derpy STL wrappers.
DISABLE_STL_WRAPPING = True
""",
#
# translator
#
  'translator': """

DIRS += [ 'src/libGLESv2', 'src/libEGL' ]

EXPORTS.angle += [ 'include/GLSLANG/ShaderLang.h' ]
EXPORTS.angle.KHR += [ 'include/KHR/khrplatform.h' ]

LOCAL_INCLUDES += [ 'include', 'src' ]

MSVC_ENABLE_PGO = True

if CONFIG['GKMEDIAS_SHARED_LIBRARY']:
    NO_VISIBILITY_FLAGS = True

# This tells ANGLE to build the translator with declspec(dllexport) on Windows
# which we need to get these symbols exported from gkmedias
DEFINES['COMPONENT_BUILD'] = True
DEFINES['ANGLE_TRANSLATOR_IMPLEMENTATION'] = True

FINAL_LIBRARY = 'gkmedias'
""",
#
# libGLESv2
#
  'libGLESv2': """
LOCAL_INCLUDES += [ '../../include', '../../src' ]
EXTRA_DSO_LDOPTS += [ 'd3d9.lib', 'dxguid.lib' ]

LIBRARY_NAME = 'libGLESv2'
FORCE_SHARED_LIB = True

RCFILE = SRCDIR + '/libGLESv2.rc'
DEFFILE = SRCDIR + '/libGLESv2.def'
""",
#
# libEGL
#
  'libEGL': """
LOCAL_INCLUDES += [ '../../include', '../../src' ]
EXTRA_DSO_LDOPTS += [ '../libGLESv2/libGLESv2.lib' ]

LIBRARY_NAME = 'libEGL'
FORCE_SHARED_LIB = True

RCFILE = SRCDIR + '/libEGL.rc'
DEFFILE = SRCDIR + '/libEGL.def'
"""
}

import json

platforms = None
relative_dir = None

def generate_platform_sources(target=None):
  sources = {}

  targetarg = ""
  if target: 
    targetarg = "-R %s " % target

  for plat in platforms:
    gyppath = os.path.join(".", "third_party", "gyp", "gyp")
    res = os.system("%s " % gyppath +
                    "--format=dump_mozbuild " +
                    "--ignore-environment " +
                    "--depth=. " +
                    "--include=build/common.gypi " +
                    "-D OS=%s " % plat +
                    "-D angle_build_samples=0 " +
                    "-D angle_build_tests=0 " +
                    "-D release_symbols=true " +
                    targetarg +
                    "build/all.gyp")
    if res != 0:
      print 'Failed to generate sources for ' + plat
      continue

    f = open('sources.json');
    s = set(map(lambda x: "src/" + x, json.load(f)))
    sources[plat] = s
    f.close()

  return dict(sources.items())


def generate_separated_sources(platform_sources):
  blacklist = [
  ]

  def isblacklisted(value):
    for item in blacklist:
      if value.find(item) >= 0:
        return True

    return False

  separated = {
    'common': set(),
    'android': set(),
    'linux': set(),
  }

  for plat in platform_sources.keys():
    if not separated.has_key(plat):
      separated[plat] = set()

    for value in platform_sources[plat]:
      if isblacklisted(value):
        continue

      found = True
      for other in platforms:
        if other == plat or not platform_sources.has_key(other):
          continue

        if not value in platform_sources[other]:
          found = False
          break

      if found:
        separated['common'].add(value)
      else:
        separated[plat].add(value)

  return separated

def uniq(seq):
  seen = set()
  seen_add = seen.add
  return [ x for x in seq if x not in seen and not seen_add(x)]

def write_cflags(f, values, subsearch, cflag, indent, prefix):
  def write_indent(indent):
    for _ in range(indent):
        f.write(' ')

  # make all dirs relative to global relative_dir
  val_list = uniq(sorted(map(lambda val: posixpath.relpath(val, relative_dir), values), key=lambda x: x.lower()))

  if len(val_list) == 0:
    return

  if prefix:
    f.write(prefix)

  for val in val_list:
    if val.find(subsearch) > 0:
      write_indent(indent)
      f.write("SOURCES[\'" + val + "\'].flags += [\'" + cflag + "\']\n")


def write_list(f, name, values, indent, prefix=None):
  def write_indent(indent):
    for _ in range(indent):
        f.write(' ')

  # make all dirs relative to global relative_dir
  val_list = uniq(sorted(map(lambda val: posixpath.relpath(val, relative_dir), values), key=lambda x: x.lower()))

  if len(val_list) == 0:
    return

  if prefix:
    f.write(prefix)

  write_indent(indent)
  f.write(name + ' += [\n')
  for val in val_list:
    write_indent(indent + 4)
    f.write('\'' + val + '\',\n')

  write_indent(indent)
  f.write(']\n')

  if name == 'SOURCES':
    for val in val_list:
      if 'SSE2' in val:
        write_indent(indent)
        f.write("SOURCES['%s'].flags += CONFIG['SSE2_FLAGS']\n" % val)

def write_mozbuild(includes, sources, target):
  if target is "translator":
    filename = "moz.build"
  elif target is "libGLESv2":
    filename = "src/libGLESv2/moz.build"
  elif target is "libEGL":
    filename = "src/libEGL/moz.build"
  else:
    print "Don't know how to create moz.build for target %s" % (target)
    sys.exit(1)

  ensured_targets = ['common', 'android', 'mac', 'linux', 'win']
  for src_target in ensured_targets:
    if src_target not in sources:
      sources[src_target] = set()

  f = open(filename, 'w')

  f.write(header)

  write_list(f, 'EXPORTS.angle', includes, 0)

  write_list(f, 'SOURCES', sources['common'], 0)

  write_list(f, 'SOURCES', sources['android'], 4,
             "if CONFIG['MOZ_WIDGET_TOOLKIT'] in ('android', 'gonk'):\n")

  write_list(f, 'SOURCES', sources['mac'], 4,
             "if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'cocoa':\n")

  write_list(f, 'SOURCES', sources['linux'], 4,
             "if CONFIG['MOZ_WIDGET_GTK']:\n")

  write_list(f, 'SOURCES', sources['linux'], 4,
             "if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'qt':\n")

  write_list(f, 'SOURCES', sources['win'], 4,
             "if CONFIG['MOZ_WIDGET_TOOLKIT'] == 'windows':\n")

  f.write("\n")
  f.write(footers['base'])
  f.write("\n")

  if target in footers:
    f.write(footers[target])

  f.close()

  print 'Wrote ' + filename

def main():
  targets = [None]
  global platforms, relative_dir

  target_platforms = {
    "translator": ['win', 'linux', 'mac', 'android'],
    "libGLESv2": ['win'],
    "libEGL": ['win']
  }

  target_dirs = {
    "translator": ".",
    "libGLESv2": "src/libGLESv2",
    "libEGL": "src/libEGL"
  }

  for target in target_platforms.keys():
    platforms = target_platforms[target]
    relative_dir = target_dirs[target]

    includes = dict()
    platform_sources = generate_platform_sources(target)
    separated_sources = generate_separated_sources(platform_sources)
    write_mozbuild(includes, separated_sources, target)

if __name__ == '__main__':
  main()
